{% extends "layouts/admin.twig" %}

{% set healthRecords = records ?? [] %}
{% set patients = patients ?? [] %}
{% set stateOptions = states ?? {} %}
{% set treatmentOptions = treatment_statuses ?? {} %}

{% block extra_css %}
  {{ parent() }}
  <style>
    .health-state-badge {
      border-radius: 999px;
      font-size: 0.75rem;
      padding: 0.35rem 0.75rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }
    .health-card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      font-size: 0.8rem;
      color: var(--bs-secondary-color);
    }
    .health-card-meta span {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    .table-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.4rem;
    }
    .table-actions .btn {
      border-radius: 0.65rem !important;
      width: 2.35rem;
      height: 2.35rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .table-actions .btn i {
      width: 1.05rem;
      text-align: center;
      font-size: 0.95rem;
    }
    .badge-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
  </style>
{% endblock %}

{% block admin_content %}
  <div id="healthModule"
       data-states="{{ stateOptions|json_encode|e('html_attr') }}"
       data-treatments="{{ treatmentOptions|json_encode|e('html_attr') }}">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
      <div>
        <h1 class="h4 mb-1"><i class="fas fa-heartbeat me-2 text-danger"></i>{{ title }}</h1>
        <p class="text-muted mb-0 small">Registre consultas, diagnósticos e evolução clínica dos usuários do MeuApp.</p>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-danger btn-sm px-3" data-bs-toggle="modal" data-bs-target="#modalHealthCreate">
          <i class="fas fa-notes-medical me-2"></i>Novo atendimento
        </button>
        <a href="/admin/pacientes" class="btn btn-outline-secondary btn-sm px-3">
          <i class="fas fa-hospital-user me-2"></i>Pacientes
        </a>
      </div>
    </div>

    {% if status is defined and status %}
      {% set alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'info': 'alert-info'
      }[status] ?? 'alert-secondary' %}
      <div class="alert {{ alertClass }} alert-dismissible fade show" role="alert">
        {{ message ?? 'Operação realizada.' }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
      </div>
    {% endif %}

    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
          <div class="d-flex align-items-center gap-2">
            <span class="badge text-bg-danger-subtle text-danger fw-semibold">{{ healthRecords|length }} atendimentos</span>
            <span class="text-muted small">Dados armazenados em <code>meuapp.tbl_meuapp_health</code></span>
          </div>
          <div class="input-group input-group-sm" style="max-width: 280px;">
            <span class="input-group-text bg-body border-end-0"><i class="fas fa-search"></i></span>
            <input type="search" class="form-control border-start-0" placeholder="Filtrar por paciente, CID ou diagnóstico" data-filter-table="#healthTable">
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle table-hover mb-0" id="healthTable">
            <thead class="table-light">
              <tr>
                <th scope="col">Paciente</th>
                <th scope="col" class="d-none d-lg-table-cell">Diagnóstico</th>
                <th scope="col" class="d-none d-lg-table-cell">CID</th>
                <th scope="col">Estado</th>
                <th scope="col" class="d-none d-xl-table-cell">Consulta</th>
                <th scope="col" class="d-none d-xl-table-cell">Tratamento</th>
                <th scope="col" class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody>
            {% if healthRecords %}
              {% for item in healthRecords %}
                {% set stateInfo = stateOptions[item.estado|default('leve')] ?? {'label': item.estado|capitalize, 'badge': 'text-bg-secondary'} %}
                {% set treatmentLabel = treatmentOptions[item.status_tratamento|default('em_andamento')] ?? 'Em andamento' %}
                <tr data-health='{{ {
                    id: item.id,
                    patient_id: item.patient_id,
                    patient_name: item.patient_name,
                    patient_email: item.patient_email,
                    patient_staff_id: item.patient_staff_id,
                    consulta_data: item.consulta_data,
                    consulta_label: item.consulta_data ? item.consulta_data|date("d/m/Y H:i") : "—",
                    consulta_input: item.consulta_data ? item.consulta_data|date("Y-m-d\\TH:i") : "",
                    estado: item.estado,
                    estado_label: stateInfo.label,
                    diagnostico: item.diagnostico,
                    cid: item.cid,
                    tratamento: item.tratamento,
                    prescricoes: item.prescricoes,
                    observacoes: item.observacoes,
                    medico_responsavel: item.medico_responsavel,
                    instituicao: item.instituicao,
                    pressao_arterial: item.pressao_arterial,
                    frequencia_cardiaca: item.frequencia_cardiaca,
                    temperatura_c: item.temperatura_c,
                    temperatura_label: item.temperatura_c is not null ? (item.temperatura_c|number_format(1, ',', '.') ~ ' °C') : '—',
                    peso_kg: item.peso_kg,
                    peso_label: item.peso_kg is not null ? (item.peso_kg|number_format(1, ',', '.') ~ ' kg') : '—',
                    altura_m: item.altura_m,
                    altura_label: item.altura_m is not null ? (item.altura_m|number_format(2, ',', '.') ~ ' m') : '—',
                    proxima_consulta: item.proxima_consulta,
                    proxima_label: item.proxima_consulta ? item.proxima_consulta|date("d/m/Y H:i") : '—',
                    proxima_input: item.proxima_consulta ? item.proxima_consulta|date("Y-m-d\\TH:i") : '',
                    status_tratamento: item.status_tratamento,
                    status_label: treatmentLabel,
                    created_at: item.created_at,
                    created_label: item.created_at ? item.created_at|date("d/m/Y H:i") : '—',
                    updated_at: item.updated_at,
                    updated_label: item.updated_at ? item.updated_at|date("d/m/Y H:i") : '—'
                }|json_encode|e('html_attr') }}'>
                  <td>
                    <div class="d-flex align-items-center gap-3">
                      <div class="avatar bg-danger-subtle text-danger fw-semibold rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 42px; height: 42px;">
                        {{ item.patient_name|default('Paciente')|slice(0,1)|upper }}
                      </div>
                      <div>
                        <div class="fw-semibold">{{ item.patient_name }}</div>
                        <div class="text-muted small d-lg-none">{{ item.diagnostico }}</div>
                        {% if item.patient_staff_id %}
                          <div class="text-muted small">ID: {{ item.patient_staff_id }}</div>
                        {% endif %}
                      </div>
                    </div>
                  </td>
                  <td class="d-none d-lg-table-cell">{{ item.diagnostico }}</td>
                  <td class="d-none d-lg-table-cell">
                    {% if item.cid %}
                      <span class="badge text-bg-secondary">{{ item.cid }}</span>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge health-state-badge {{ stateInfo.badge }}">{{ stateInfo.label }}</span>
                  </td>
                  <td class="d-none d-xl-table-cell text-muted small">
                    {{ item.consulta_data ? item.consulta_data|date("d/m/Y H:i") : '—' }}
                  </td>
                  <td class="d-none d-xl-table-cell text-muted small">{{ treatmentLabel }}</td>
                  <td class="text-end">
                    <div class="table-actions">
                      <button
                        class="btn btn-outline-secondary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#modalHealthView"
                        data-action="fill-view">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button
                        class="btn btn-outline-primary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#modalHealthEdit"
                        data-action="fill-edit">
                        <i class="fas fa-pen"></i>
                      </button>
                      <form action="/admin/health/delete" method="post" class="d-inline">
                        <input type="hidden" name="id" value="{{ item.id }}">
                        <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Remover atendimento de {{ item.patient_name }}?')">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center py-4 text-muted">
                  <i class="fas fa-notes-medical fa-2x mb-2 d-block"></i>
                  Nenhum atendimento registrado até o momento.
                </td>
              </tr>
            {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {# Modal: Ver atendimento #}
    <div class="modal fade" id="modalHealthView" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-notes-medical me-2 text-danger"></i>Detalhes do atendimento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex align-items-center gap-3 mb-3">
              <div class="avatar bg-danger text-white fw-bold rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 56px; height: 56px;" data-view-avatar>?</div>
              <div>
                <h5 class="mb-1" data-view-patient>Paciente</h5>
                <p class="text-muted mb-0 small" data-view-email>email@meuapp.local</p>
                <p class="text-muted mb-0 small" data-view-staff>ID: —</p>
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-sm-4">
                <span class="text-muted text-uppercase small fw-semibold d-block">Estado</span>
                <span data-view-state></span>
              </div>
              <div class="col-sm-4">
                <span class="text-muted text-uppercase small fw-semibold d-block">Diagnóstico</span>
                <p class="mb-0" data-view-diagnostico>—</p>
              </div>
              <div class="col-sm-4">
                <span class="text-muted text-uppercase small fw-semibold d-block">CID</span>
                <p class="mb-0" data-view-cid>—</p>
              </div>
              <div class="col-sm-6">
                <span class="text-muted text-uppercase small fw-semibold d-block">Consulta</span>
                <p class="mb-0" data-view-consulta>—</p>
              </div>
              <div class="col-sm-6">
                <span class="text-muted text-uppercase small fw-semibold d-block">Próxima consulta</span>
                <p class="mb-0" data-view-proxima>—</p>
              </div>
              <div class="col-sm-6">
                <span class="text-muted text-uppercase small fw-semibold d-block">Médico responsável</span>
                <p class="mb-0" data-view-medico>—</p>
              </div>
              <div class="col-sm-6">
                <span class="text-muted text-uppercase small fw-semibold d-block">Instituição</span>
                <p class="mb-0" data-view-instituicao>—</p>
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-sm-4">
                <span class="text-muted text-uppercase small fw-semibold d-block">Pressão arterial</span>
                <p class="mb-0" data-view-pressao>—</p>
              </div>
              <div class="col-sm-4">
                <span class="text-muted text-uppercase small fw-semibold d-block">Frequência cardíaca</span>
                <p class="mb-0" data-view-frequencia>—</p>
              </div>
              <div class="col-sm-4">
                <span class="text-muted text-uppercase small fw-semibold d-block">Temperatura</span>
                <p class="mb-0" data-view-temperatura>—</p>
              </div>
              <div class="col-sm-4">
                <span class="text-muted text-uppercase small fw-semibold d-block">Peso</span>
                <p class="mb-0" data-view-peso>—</p>
              </div>
              <div class="col-sm-4">
                <span class="text-muted text-uppercase small fw-semibold d-block">Altura</span>
                <p class="mb-0" data-view-altura>—</p>
              </div>
              <div class="col-sm-4">
                <span class="text-muted text-uppercase small fw-semibold d-block">Tratamento</span>
                <p class="mb-0" data-view-tratamento-status>—</p>
              </div>
            </div>

            <div class="mb-3">
              <span class="text-muted text-uppercase small fw-semibold d-block">Tratamento recomendado</span>
              <p class="mb-0" data-view-tratamento>—</p>
            </div>

            <div class="mb-3">
              <span class="text-muted text-uppercase small fw-semibold d-block">Prescrições</span>
              <p class="mb-0" data-view-prescricoes>—</p>
            </div>

            <div class="mb-0">
              <span class="text-muted text-uppercase small fw-semibold d-block">Observações</span>
              <p class="mb-0" data-view-observacoes>—</p>
            </div>
          </div>
          <div class="modal-footer">
            <small class="text-muted me-auto">Atualizado em <span data-view-updated>—</span></small>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
            <button type="button" class="btn btn-primary btn-sm" data-view-open-edit>
              <i class="fas fa-pen me-2"></i>Editar
            </button>
          </div>
        </div>
      </div>
    </div>

    {# Modal: Novo atendimento #}
    <div class="modal fade" id="modalHealthCreate" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <form action="/admin/health/store" method="post" class="modal-content needs-validation" novalidate>
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-notes-medical me-2 text-danger"></i>Novo atendimento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="createPatient" class="form-label">Paciente</label>
                <select name="user_id" id="createPatient" class="form-select" required>
                  <option value="">Selecione um paciente</option>
                  {% for patient in patients %}
                    <option value="{{ patient.id }}">{{ patient.name }}{% if patient.email %} — {{ patient.email }}{% endif %}</option>
                  {% endfor %}
                </select>
                <div class="invalid-feedback">Escolha um paciente.</div>
              </div>
              <div class="col-md-6">
                <label for="createConsulta" class="form-label">Data da consulta</label>
                <input type="datetime-local" class="form-control" name="consulta_data" id="createConsulta" required>
                <div class="invalid-feedback">Informe a data e hora do atendimento.</div>
              </div>
              <div class="col-md-6">
                <label for="createEstado" class="form-label">Estado do paciente</label>
                <select name="estado" id="createEstado" class="form-select">
                  {% for key, info in stateOptions %}
                    <option value="{{ key }}">{{ info.label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="createDiagnostico" class="form-label">Diagnóstico</label>
                <input type="text" class="form-control" name="diagnostico" id="createDiagnostico" required>
                <div class="invalid-feedback">Informe o diagnóstico registrado.</div>
              </div>
              <div class="col-md-4">
                <label for="createCid" class="form-label">CID</label>
                <input type="text" class="form-control" name="cid" id="createCid" placeholder="Ex.: J45">
              </div>
              <div class="col-md-4">
                <label for="createMedico" class="form-label">Médico responsável</label>
                <input type="text" class="form-control" name="medico_responsavel" id="createMedico">
              </div>
              <div class="col-md-4">
                <label for="createInstituicao" class="form-label">Instituição/Clínica</label>
                <input type="text" class="form-control" name="instituicao" id="createInstituicao">
              </div>
              <div class="col-md-4">
                <label for="createPressao" class="form-label">Pressão arterial</label>
                <input type="text" class="form-control" name="pressao_arterial" id="createPressao" placeholder="120x80">
              </div>
              <div class="col-md-4">
                <label for="createFrequencia" class="form-label">Frequência cardíaca (bpm)</label>
                <input type="number" class="form-control" name="frequencia_cardiaca" id="createFrequencia" min="30" max="220">
              </div>
              <div class="col-md-4">
                <label for="createTemperatura" class="form-label">Temperatura (°C)</label>
                <input type="number" class="form-control" name="temperatura_c" id="createTemperatura" step="0.1">
              </div>
              <div class="col-md-4">
                <label for="createPeso" class="form-label">Peso (kg)</label>
                <input type="number" class="form-control" name="peso_kg" id="createPeso" step="0.1">
              </div>
              <div class="col-md-4">
                <label for="createAltura" class="form-label">Altura (m)</label>
                <input type="number" class="form-control" name="altura_m" id="createAltura" step="0.01">
              </div>
              <div class="col-md-4">
                <label for="createProxima" class="form-label">Próxima consulta</label>
                <input type="datetime-local" class="form-control" name="proxima_consulta" id="createProxima">
              </div>
              <div class="col-md-6">
                <label for="createTratamentoStatus" class="form-label">Status do tratamento</label>
                <select name="status_tratamento" id="createTratamentoStatus" class="form-select">
                  {% for key, label in treatmentOptions %}
                    <option value="{{ key }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12">
                <label for="createTratamento" class="form-label">Tratamento recomendado</label>
                <textarea class="form-control" name="tratamento" id="createTratamento" rows="2"></textarea>
              </div>
              <div class="col-12">
                <label for="createPrescricoes" class="form-label">Prescrições</label>
                <textarea class="form-control" name="prescricoes" id="createPrescricoes" rows="2"></textarea>
              </div>
              <div class="col-12">
                <label for="createObservacoes" class="form-label">Observações adicionais</label>
                <textarea class="form-control" name="observacoes" id="createObservacoes" rows="2"></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger btn-sm">Salvar atendimento</button>
          </div>
        </form>
      </div>
    </div>

    {# Modal: Editar atendimento #}
    <div class="modal fade" id="modalHealthEdit" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <form action="/admin/health/update" method="post" class="modal-content needs-validation" novalidate>
          <input type="hidden" name="id" id="editHealthId">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-pen me-2 text-danger"></i>Editar atendimento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="editPatient" class="form-label">Paciente</label>
                <select name="user_id" id="editPatient" class="form-select" required>
                  <option value="">Selecione um paciente</option>
                  {% for patient in patients %}
                    <option value="{{ patient.id }}">{{ patient.name }}{% if patient.email %} — {{ patient.email }}{% endif %}</option>
                  {% endfor %}
                </select>
                <div class="invalid-feedback">Escolha um paciente.</div>
              </div>
              <div class="col-md-6">
                <label for="editConsulta" class="form-label">Data da consulta</label>
                <input type="datetime-local" class="form-control" name="consulta_data" id="editConsulta" required>
                <div class="invalid-feedback">Informe a data e hora do atendimento.</div>
              </div>
              <div class="col-md-6">
                <label for="editEstado" class="form-label">Estado do paciente</label>
                <select name="estado" id="editEstado" class="form-select">
                  {% for key, info in stateOptions %}
                    <option value="{{ key }}">{{ info.label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="editDiagnostico" class="form-label">Diagnóstico</label>
                <input type="text" class="form-control" name="diagnostico" id="editDiagnostico" required>
                <div class="invalid-feedback">Informe o diagnóstico registrado.</div>
              </div>
              <div class="col-md-4">
                <label for="editCid" class="form-label">CID</label>
                <input type="text" class="form-control" name="cid" id="editCid">
              </div>
              <div class="col-md-4">
                <label for="editMedico" class="form-label">Médico responsável</label>
                <input type="text" class="form-control" name="medico_responsavel" id="editMedico">
              </div>
              <div class="col-md-4">
                <label for="editInstituicao" class="form-label">Instituição/Clínica</label>
                <input type="text" class="form-control" name="instituicao" id="editInstituicao">
              </div>
              <div class="col-md-4">
                <label for="editPressao" class="form-label">Pressão arterial</label>
                <input type="text" class="form-control" name="pressao_arterial" id="editPressao">
              </div>
              <div class="col-md-4">
                <label for="editFrequencia" class="form-label">Frequência cardíaca (bpm)</label>
                <input type="number" class="form-control" name="frequencia_cardiaca" id="editFrequencia" min="30" max="220">
              </div>
              <div class="col-md-4">
                <label for="editTemperatura" class="form-label">Temperatura (°C)</label>
                <input type="number" class="form-control" name="temperatura_c" id="editTemperatura" step="0.1">
              </div>
              <div class="col-md-4">
                <label for="editPeso" class="form-label">Peso (kg)</label>
                <input type="number" class="form-control" name="peso_kg" id="editPeso" step="0.1">
              </div>
              <div class="col-md-4">
                <label for="editAltura" class="form-label">Altura (m)</label>
                <input type="number" class="form-control" name="altura_m" id="editAltura" step="0.01">
              </div>
              <div class="col-md-4">
                <label for="editProxima" class="form-label">Próxima consulta</label>
                <input type="datetime-local" class="form-control" name="proxima_consulta" id="editProxima">
              </div>
              <div class="col-md-6">
                <label for="editTratamentoStatus" class="form-label">Status do tratamento</label>
                <select name="status_tratamento" id="editTratamentoStatus" class="form-select">
                  {% for key, label in treatmentOptions %}
                    <option value="{{ key }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12">
                <label for="editTratamento" class="form-label">Tratamento recomendado</label>
                <textarea class="form-control" name="tratamento" id="editTratamento" rows="2"></textarea>
              </div>
              <div class="col-12">
                <label for="editPrescricoes" class="form-label">Prescrições</label>
                <textarea class="form-control" name="prescricoes" id="editPrescricoes" rows="2"></textarea>
              </div>
              <div class="col-12">
                <label for="editObservacoes" class="form-label">Observações adicionais</label>
                <textarea class="form-control" name="observacoes" id="editObservacoes" rows="2"></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger btn-sm">Atualizar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  {{ parent() }}
  <script>
    (function () {
      'use strict';

      const moduleRoot = document.getElementById('healthModule');
      if (!moduleRoot) return;

      const stateOptions = safeParse(moduleRoot.dataset.states || '{}');
      const treatmentOptions = safeParse(moduleRoot.dataset.treatments || '{}');

      function safeParse(raw) {
        try {
          return JSON.parse(raw);
        } catch (e) {
          return {};
        }
      }

      function initials(name) {
        if (!name) return '?';
        const parts = name.trim().split(/\s+/).filter(Boolean);
        if (parts.length === 0) return '?';
        if (parts.length === 1) return parts[0].slice(0, 2).toUpperCase();
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }

      const filterInput = moduleRoot.querySelector('[data-filter-table]');
      if (filterInput) {
        const selector = filterInput.getAttribute('data-filter-table');
        const table = selector ? moduleRoot.querySelector(selector) : null;
        filterInput.addEventListener('input', function () {
          if (!table) return;
          const term = this.value.trim().toLowerCase();
          table.querySelectorAll('tbody tr').forEach(function (row) {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
          });
        });
      }

      function applyFormValidation(form) {
        if (!form) {
          return;
        }

        form.addEventListener('submit', function (event) {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
            form.classList.add('was-validated');

            const firstInvalid = form.querySelector(':invalid');
            if (firstInvalid) {
              firstInvalid.focus({ preventScroll: false });
              firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        });
      }

      applyFormValidation(document.querySelector('#modalHealthCreate form'));
      applyFormValidation(document.querySelector('#modalHealthEdit form'));

      function fillViewModal(data) {
        const avatar = document.querySelector('[data-view-avatar]');
        const patient = document.querySelector('[data-view-patient]');
        const email = document.querySelector('[data-view-email]');
        const staff = document.querySelector('[data-view-staff]');
        const state = document.querySelector('[data-view-state]');

        if (avatar) {
          avatar.textContent = initials(data.patient_name);
        }
        if (patient) patient.textContent = data.patient_name || 'Paciente';
        if (email) email.textContent = data.patient_email || '—';
        if (staff) staff.textContent = data.patient_staff_id ? `ID: ${data.patient_staff_id}` : 'ID: —';

        if (state) {
          const info = stateOptions[data.estado] || { label: data.estado || '—', badge: 'text-bg-secondary' };
          state.innerHTML = `<span class="badge health-state-badge ${info.badge}">${info.label}</span>`;
        }

        setText('[data-view-diagnostico]', data.diagnostico);
        setText('[data-view-cid]', data.cid || '—');
        setText('[data-view-consulta]', data.consulta_label);
        setText('[data-view-proxima]', data.proxima_label);
        setText('[data-view-medico]', data.medico_responsavel || '—');
        setText('[data-view-instituicao]', data.instituicao || '—');
        setText('[data-view-pressao]', data.pressao_arterial || '—');
        setText('[data-view-frequencia]', data.frequencia_cardiaca ? `${data.frequencia_cardiaca} bpm` : '—');
        setText('[data-view-temperatura]', data.temperatura_label || '—');
        setText('[data-view-peso]', data.peso_label || '—');
        setText('[data-view-altura]', data.altura_label || '—');

        const tratamentoStatus = treatmentOptions[data.status_tratamento] || '—';
        setText('[data-view-tratamento-status]', tratamentoStatus);
        setText('[data-view-tratamento]', data.tratamento || '—');
        setText('[data-view-prescricoes]', data.prescricoes || '—');
        setText('[data-view-observacoes]', data.observacoes || '—');

        setText('[data-view-updated]', data.updated_label || '—');

        const viewEditButton = document.querySelector('[data-view-open-edit]');
        if (viewEditButton) {
          viewEditButton.onclick = function () {
            const editModal = document.getElementById('modalHealthEdit');
            if (!editModal) return;
            const modalInstance = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalHealthView'));
            modalInstance.hide();
            fillEditModal(data);
            bootstrap.Modal.getOrCreateInstance(editModal).show();
          };
        }
      }

      function fillEditModal(data) {
        setValue('#editHealthId', data.id);
        setValue('#editPatient', data.patient_id);
        setValue('#editConsulta', data.consulta_input);
        setValue('#editEstado', data.estado);
        setValue('#editDiagnostico', data.diagnostico);
        setValue('#editCid', data.cid);
        setValue('#editMedico', data.medico_responsavel);
        setValue('#editInstituicao', data.instituicao);
        setValue('#editPressao', data.pressao_arterial);
        setValue('#editFrequencia', data.frequencia_cardiaca);
        setValue('#editTemperatura', data.temperatura_c);
        setValue('#editPeso', data.peso_kg);
        setValue('#editAltura', data.altura_m);
        setValue('#editProxima', data.proxima_input);
        setValue('#editTratamentoStatus', data.status_tratamento);
        setValue('#editTratamento', data.tratamento);
        setValue('#editPrescricoes', data.prescricoes);
        setValue('#editObservacoes', data.observacoes);
      }

      function setText(selector, value) {
        const el = document.querySelector(selector);
        if (el) {
          el.textContent = value !== undefined && value !== null && value !== '' ? value : '—';
        }
      }

      function setValue(selector, value) {
        const el = document.querySelector(selector);
        if (!el) return;
        el.value = value ?? '';
      }

      moduleRoot.querySelectorAll('[data-action="fill-view"]').forEach(function (button) {
        button.addEventListener('click', function () {
          const row = this.closest('tr');
          if (!row) return;
          const raw = row.getAttribute('data-health');
          const data = safeParse(raw);
          fillViewModal(data);
        });
      });

      moduleRoot.querySelectorAll('[data-action="fill-edit"]').forEach(function (button) {
        button.addEventListener('click', function () {
          const row = this.closest('tr');
          if (!row) return;
          const raw = row.getAttribute('data-health');
          const data = safeParse(raw);
          fillEditModal(data);
        });
      });
    })();
  </script>
{% endblock %}
